/*
** NOTE: This file is generated by Gulp and should not be edited directly!
** Any changes made directly to this file will be overwritten next time its asset group is processed by Gulp.
*/

$(document).ready(function() {
    var $relatedContentAddButton = $('.js-add-related-content');
    $relatedContentForm = $('.js-related-content-form'),
        $relatedContentContentSection = $('.js-related-content-content'),
        $relatedContentUrlSection = $('.js-related-content-url-section'),
        $relatedContentContentId = $('.js-related-content-item-id'),
        $relatedContentContentDisplayLink = $('.js-related-content-item-display-link'),
        $relatedContentContentTitle = $('.js-related-content-selected-content'),
        $relatedContentText = $('.js-related-content-text'),
        $relatedContentTypes = $('.js-related-content-types'),
        $relatedContentSaveButton = $('.js-related-content-save-button'),
        $relatedContentJson = $('#RelatedContent_RelatedContentJson'),
        $relatedContentsList = $('.js-related-contents-links-list'),
        $relatedContentsListContainer = $('.js-related-contents-links-list-container'),
        $relatedContentUnpublishedContent = $('.js-related-content-unpublished-content'),
        currentContentLinks = [],
        mode = 'new',
        editIndex = 0;

    /**
     * Returns the id of the selected content item.
     */
    var getRelatedContentContentItemId = function() {
        return ($relatedContentContentSection.is(':visible')) ? $relatedContentContentId.val() : 0;
    };

    /**
     * Returns the text for the related link.
     */
    var getRelatedContentText = function() {
        return $relatedContentText.val().trim();
    };

    /**
     * Validates the related content item entry and enabled / disables
     * the save button.
     */
    var validate = function() {
        var valid = true;

        // user hasn't entered any text for the content item.
        if ($relatedContentText.val().trim() === '') {
            valid = false;
        }

        // user hasn't selected a content item.
        if ($relatedContentContentId.val() === '-1') {
            valid = false;
        }

        // user has chosen an unpublished content item.
        if ($relatedContentUnpublishedContent.is(':visible') === true) {
            valid = false;
        }

        (valid === true) ? $relatedContentSaveButton.removeClass('disabled'): $relatedContentSaveButton.addClass('disabled');
    };

    /**
     * Resets the form.
     */
    var resetForm = function() {
        $relatedContentForm.hide();
        $relatedContentText.val('');
        $relatedContentContentId.val('-1');
        $relatedContentContentDisplayLink.val('');
        $relatedContentAddButton.show();
        $relatedContentContentTitle.html('');
        $relatedContentUnpublishedContent.hide();
        validate();
    };

    resetForm();
    try {
        currentContentLinks = JSON.parse($relatedContentJson.val());
    } catch (error) {
        currentContentLinks = [];
    }

    // shows the form when the user clicks the add button.
    $relatedContentAddButton.on('click', function() {
        mode = 'new';
        $relatedContentForm.show();
        $relatedContentAddButton.hide();
    });

    // resets the form when the user clicks the cancel button.
    $('.js-related-content-cancel-button').on('click', function() {
        resetForm();
        resetEdit();
    });

    // user wishes to select the related content item.
    $('.js-related-content-select-content-btn').on('click', function() {
        $relatedContentContentId.trigger("orchard-admin-contentpicker-open", {
            callback: function(data) {
                $relatedContentContentId.val(data.id);
                $relatedContentContentTitle.html(data.displayText);
                if (typeof(data.displayLink) !== 'undefined') {
                    var $link = $(data.displayLink);
                    if ($link.length > 0) {
                        data.displayLink = $link.attr('target', '_blank')[0].outerHTML;
                    }
                }
                $relatedContentContentDisplayLink.val(data.displayLink);
                $relatedContentText.val(data.displayText);

                (data.displayLink.indexOf('Contents/Item/Display/' + data.id) >= 0) ? $relatedContentUnpublishedContent.show(): $relatedContentUnpublishedContent.hide();

                validate();
            },
            types: $relatedContentTypes.val(),
            baseUrl: '/'
        });
    });

    // user filling out the form.
    $('.js-related-content-text').on('keyup', validate);

    // user attempting to save a related link item.
    $relatedContentSaveButton.on('click', function() {
        // entered related link item is currently invalid.
        if ($relatedContentSaveButton.hasClass('disabled')) {
            return;
        }
        var newItem = {};
        if (mode === 'new') {
            newItem = {
                ContentItemId: getRelatedContentContentItemId(),
                Label: getRelatedContentText()
            };

            // adds the new link to the array of current related links.
            currentContentLinks.push(newItem);

            // adds the new link to the list of the currently related links shown to the user.
            var html = '<li class="last"><div class="summary"><div class="properties"><h3>' + newItem.Label + '</h3> - ';
            html += (newItem.ContentItemId !== 0) ? $relatedContentContentDisplayLink.val() : '<a href=' + newItem.Url + ' target="_blank">' + newItem.Url + '</a>';
            html += '</div><div class="related"><a href="#" data-index="' + (currentContentLinks.length - 1) + '" class="js-edit-related-content">Edit</a> | <a href="#" data-index="' + (currentContentLinks.length - 1) + '" class="js-remove-related-content">Delete</a></div></div></li>';

            $relatedContentsList.children().removeClass('last');
            $relatedContentsList.append(html);
        } else {
            //update existing element and show
            // finds link in the list.
            var $item = $relatedContentsList.find('[data-index=' + editIndex + ']').parents('li');

            // finds link in the current items array.
            var itemIndex = -1;
            for (var i = 0; i < currentContentLinks.length; i++) {
                if (currentContentLinks[i].Label === $item.find('h3').text()) {
                    itemIndex = i;
                }
            }

            currentContentLinks[itemIndex].ContentItemId = getRelatedContentContentItemId();
            currentContentLinks[itemIndex].Label = getRelatedContentText();

            var $properties = $item.find('.properties');
            $properties.find('h3').text(currentContentLinks[itemIndex].Label);
            $properties.find('a').remove();
            $properties.append($relatedContentContentDisplayLink.val());
            resetEdit();
        }

        // updates the JSON that will be passed to the server.
        $relatedContentJson.val(JSON.stringify(currentContentLinks));

        $relatedContentsListContainer.show();

        $('.js-remove-related-content').on('click', removeLink);
        $('.js-edit-related-content').on('click', editLink);

        resetForm();
    });

    /**
     * Removes an existing related link.
     */
    var removeLink = function() {
        var index = $(this).attr('data-index');

        // removes link from the list.
        var $item = $relatedContentsList.find('[data-index=' + index + ']').parents('li');

        // removes link from the current items array.
        var itemIndex = -1;
        for (var i = 0; i < currentContentLinks.length; i++) {
            if (currentContentLinks[i].Label === $item.find('h3').text()) {
                itemIndex = i;
            }
        }

        if (itemIndex > -1) {
            currentContentLinks.splice(itemIndex, 1);
        }

        $item.remove();

        // updates the JSON that will be passed to the server.
        $relatedContentJson.val(JSON.stringify(currentContentLinks));

        // hide the links list if there aren't any.
        if (currentContentLinks.length === 0) {
            $relatedContentsListContainer.hide();
        }

        // ensure the hyperlink doesn't trigger.
        return false;
    }

    /**
     * Edits an existing related link.
     */
    var editLink = function() {
        resetEdit();
        mode = 'edit';
        var index = $(this).attr('data-index');

        // finds link in the list.
        var $item = $relatedContentsList.find('[data-index=' + index + ']').parents('li');

        // finds link in the current items array.
        var itemIndex = -1;
        for (var i = 0; i < currentContentLinks.length; i++) {
            if (currentContentLinks[i].Label === $item.find('h3').text()) {
                itemIndex = i;
            }
        }

        $item.hide();

        editIndex = itemIndex;

        // updates the ui to display edit for this item
        $relatedContentForm.show();
        $relatedContentAddButton.hide();
        var $properties = $item.find('.properties');
        $relatedContentText.val($properties.find('h3').text());
        $relatedContentContentId.val(currentContentLinks[itemIndex].ContentItemId);
        $relatedContentContentTitle.text($properties.find('a').text());
        $relatedContentContentDisplayLink.val($properties.find('a')[0].outerHTML);
        validate();

        // ensure the hyperlink doesn't trigger.
        return false;
    };

    var resetEdit = function() {
        $('.js-related-contents-links-list > li').show();
    };

    // removing a current related link.
    $('.js-remove-related-content').on('click', removeLink);
    // editing a current related link.
    $('.js-edit-related-content').on('click', editLink);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlbGF0ZWRjb250ZW50LmFkbWluLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxBQUxBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoicmVsYXRlZGNvbnRlbnQuYWRtaW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHtcclxuICAgIHZhciAkcmVsYXRlZENvbnRlbnRBZGRCdXR0b24gPSAkKCcuanMtYWRkLXJlbGF0ZWQtY29udGVudCcpO1xyXG4gICAgJHJlbGF0ZWRDb250ZW50Rm9ybSA9ICQoJy5qcy1yZWxhdGVkLWNvbnRlbnQtZm9ybScpLFxyXG4gICAgICAgICRyZWxhdGVkQ29udGVudENvbnRlbnRTZWN0aW9uID0gJCgnLmpzLXJlbGF0ZWQtY29udGVudC1jb250ZW50JyksXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50VXJsU2VjdGlvbiA9ICQoJy5qcy1yZWxhdGVkLWNvbnRlbnQtdXJsLXNlY3Rpb24nKSxcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50SWQgPSAkKCcuanMtcmVsYXRlZC1jb250ZW50LWl0ZW0taWQnKSxcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50RGlzcGxheUxpbmsgPSAkKCcuanMtcmVsYXRlZC1jb250ZW50LWl0ZW0tZGlzcGxheS1saW5rJyksXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Q29udGVudFRpdGxlID0gJCgnLmpzLXJlbGF0ZWQtY29udGVudC1zZWxlY3RlZC1jb250ZW50JyksXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50VGV4dCA9ICQoJy5qcy1yZWxhdGVkLWNvbnRlbnQtdGV4dCcpLFxyXG4gICAgICAgICRyZWxhdGVkQ29udGVudFR5cGVzID0gJCgnLmpzLXJlbGF0ZWQtY29udGVudC10eXBlcycpLFxyXG4gICAgICAgICRyZWxhdGVkQ29udGVudFNhdmVCdXR0b24gPSAkKCcuanMtcmVsYXRlZC1jb250ZW50LXNhdmUtYnV0dG9uJyksXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50SnNvbiA9ICQoJyNSZWxhdGVkQ29udGVudF9SZWxhdGVkQ29udGVudEpzb24nKSxcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRzTGlzdCA9ICQoJy5qcy1yZWxhdGVkLWNvbnRlbnRzLWxpbmtzLWxpc3QnKSxcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRzTGlzdENvbnRhaW5lciA9ICQoJy5qcy1yZWxhdGVkLWNvbnRlbnRzLWxpbmtzLWxpc3QtY29udGFpbmVyJyksXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50VW5wdWJsaXNoZWRDb250ZW50ID0gJCgnLmpzLXJlbGF0ZWQtY29udGVudC11bnB1Ymxpc2hlZC1jb250ZW50JyksXHJcbiAgICAgICAgY3VycmVudENvbnRlbnRMaW5rcyA9IFtdLFxyXG4gICAgICAgIG1vZGUgPSAnbmV3JyxcclxuICAgICAgICBlZGl0SW5kZXggPSAwO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0dXJucyB0aGUgaWQgb2YgdGhlIHNlbGVjdGVkIGNvbnRlbnQgaXRlbS5cclxuICAgICAqL1xyXG4gICAgdmFyIGdldFJlbGF0ZWRDb250ZW50Q29udGVudEl0ZW1JZCA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiAoJHJlbGF0ZWRDb250ZW50Q29udGVudFNlY3Rpb24uaXMoJzp2aXNpYmxlJykpID8gJHJlbGF0ZWRDb250ZW50Q29udGVudElkLnZhbCgpIDogMDtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIHRoZSB0ZXh0IGZvciB0aGUgcmVsYXRlZCBsaW5rLlxyXG4gICAgICovXHJcbiAgICB2YXIgZ2V0UmVsYXRlZENvbnRlbnRUZXh0ID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuICRyZWxhdGVkQ29udGVudFRleHQudmFsKCkudHJpbSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIFZhbGlkYXRlcyB0aGUgcmVsYXRlZCBjb250ZW50IGl0ZW0gZW50cnkgYW5kIGVuYWJsZWQgLyBkaXNhYmxlc1xyXG4gICAgICogdGhlIHNhdmUgYnV0dG9uLlxyXG4gICAgICovXHJcbiAgICB2YXIgdmFsaWRhdGUgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgdmFsaWQgPSB0cnVlO1xyXG5cclxuICAgICAgICAvLyB1c2VyIGhhc24ndCBlbnRlcmVkIGFueSB0ZXh0IGZvciB0aGUgY29udGVudCBpdGVtLlxyXG4gICAgICAgIGlmICgkcmVsYXRlZENvbnRlbnRUZXh0LnZhbCgpLnRyaW0oKSA9PT0gJycpIHtcclxuICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHVzZXIgaGFzbid0IHNlbGVjdGVkIGEgY29udGVudCBpdGVtLlxyXG4gICAgICAgIGlmICgkcmVsYXRlZENvbnRlbnRDb250ZW50SWQudmFsKCkgPT09ICctMScpIHtcclxuICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHVzZXIgaGFzIGNob3NlbiBhbiB1bnB1Ymxpc2hlZCBjb250ZW50IGl0ZW0uXHJcbiAgICAgICAgaWYgKCRyZWxhdGVkQ29udGVudFVucHVibGlzaGVkQ29udGVudC5pcygnOnZpc2libGUnKSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICB2YWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgKHZhbGlkID09PSB0cnVlKSA/ICRyZWxhdGVkQ29udGVudFNhdmVCdXR0b24ucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk6ICRyZWxhdGVkQ29udGVudFNhdmVCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVzZXRzIHRoZSBmb3JtLlxyXG4gICAgICovXHJcbiAgICB2YXIgcmVzZXRGb3JtID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Rm9ybS5oaWRlKCk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50VGV4dC52YWwoJycpO1xyXG4gICAgICAgICRyZWxhdGVkQ29udGVudENvbnRlbnRJZC52YWwoJy0xJyk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Q29udGVudERpc3BsYXlMaW5rLnZhbCgnJyk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50QWRkQnV0dG9uLnNob3coKTtcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50VGl0bGUuaHRtbCgnJyk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50VW5wdWJsaXNoZWRDb250ZW50LmhpZGUoKTtcclxuICAgICAgICB2YWxpZGF0ZSgpO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXNldEZvcm0oKTtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY3VycmVudENvbnRlbnRMaW5rcyA9IEpTT04ucGFyc2UoJHJlbGF0ZWRDb250ZW50SnNvbi52YWwoKSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGN1cnJlbnRDb250ZW50TGlua3MgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93cyB0aGUgZm9ybSB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgYWRkIGJ1dHRvbi5cclxuICAgICRyZWxhdGVkQ29udGVudEFkZEJ1dHRvbi5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcclxuICAgICAgICBtb2RlID0gJ25ldyc7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Rm9ybS5zaG93KCk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50QWRkQnV0dG9uLmhpZGUoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIHJlc2V0cyB0aGUgZm9ybSB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgY2FuY2VsIGJ1dHRvbi5cclxuICAgICQoJy5qcy1yZWxhdGVkLWNvbnRlbnQtY2FuY2VsLWJ1dHRvbicpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJlc2V0Rm9ybSgpO1xyXG4gICAgICAgIHJlc2V0RWRpdCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gdXNlciB3aXNoZXMgdG8gc2VsZWN0IHRoZSByZWxhdGVkIGNvbnRlbnQgaXRlbS5cclxuICAgICQoJy5qcy1yZWxhdGVkLWNvbnRlbnQtc2VsZWN0LWNvbnRlbnQtYnRuJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Q29udGVudElkLnRyaWdnZXIoXCJvcmNoYXJkLWFkbWluLWNvbnRlbnRwaWNrZXItb3BlblwiLCB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50SWQudmFsKGRhdGEuaWQpO1xyXG4gICAgICAgICAgICAgICAgJHJlbGF0ZWRDb250ZW50Q29udGVudFRpdGxlLmh0bWwoZGF0YS5kaXNwbGF5VGV4dCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKGRhdGEuZGlzcGxheUxpbmspICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciAkbGluayA9ICQoZGF0YS5kaXNwbGF5TGluayk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCRsaW5rLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5kaXNwbGF5TGluayA9ICRsaW5rLmF0dHIoJ3RhcmdldCcsICdfYmxhbmsnKVswXS5vdXRlckhUTUw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHJlbGF0ZWRDb250ZW50Q29udGVudERpc3BsYXlMaW5rLnZhbChkYXRhLmRpc3BsYXlMaW5rKTtcclxuICAgICAgICAgICAgICAgICRyZWxhdGVkQ29udGVudFRleHQudmFsKGRhdGEuZGlzcGxheVRleHQpO1xyXG5cclxuICAgICAgICAgICAgICAgIChkYXRhLmRpc3BsYXlMaW5rLmluZGV4T2YoJ0NvbnRlbnRzL0l0ZW0vRGlzcGxheS8nICsgZGF0YS5pZCkgPj0gMCkgPyAkcmVsYXRlZENvbnRlbnRVbnB1Ymxpc2hlZENvbnRlbnQuc2hvdygpOiAkcmVsYXRlZENvbnRlbnRVbnB1Ymxpc2hlZENvbnRlbnQuaGlkZSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhbGlkYXRlKCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHR5cGVzOiAkcmVsYXRlZENvbnRlbnRUeXBlcy52YWwoKSxcclxuICAgICAgICAgICAgYmFzZVVybDogJy8nXHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyB1c2VyIGZpbGxpbmcgb3V0IHRoZSBmb3JtLlxyXG4gICAgJCgnLmpzLXJlbGF0ZWQtY29udGVudC10ZXh0Jykub24oJ2tleXVwJywgdmFsaWRhdGUpO1xyXG5cclxuICAgIC8vIHVzZXIgYXR0ZW1wdGluZyB0byBzYXZlIGEgcmVsYXRlZCBsaW5rIGl0ZW0uXHJcbiAgICAkcmVsYXRlZENvbnRlbnRTYXZlQnV0dG9uLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIGVudGVyZWQgcmVsYXRlZCBsaW5rIGl0ZW0gaXMgY3VycmVudGx5IGludmFsaWQuXHJcbiAgICAgICAgaWYgKCRyZWxhdGVkQ29udGVudFNhdmVCdXR0b24uaGFzQ2xhc3MoJ2Rpc2FibGVkJykpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbmV3SXRlbSA9IHt9O1xyXG4gICAgICAgIGlmIChtb2RlID09PSAnbmV3Jykge1xyXG4gICAgICAgICAgICBuZXdJdGVtID0ge1xyXG4gICAgICAgICAgICAgICAgQ29udGVudEl0ZW1JZDogZ2V0UmVsYXRlZENvbnRlbnRDb250ZW50SXRlbUlkKCksXHJcbiAgICAgICAgICAgICAgICBMYWJlbDogZ2V0UmVsYXRlZENvbnRlbnRUZXh0KClcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFkZHMgdGhlIG5ldyBsaW5rIHRvIHRoZSBhcnJheSBvZiBjdXJyZW50IHJlbGF0ZWQgbGlua3MuXHJcbiAgICAgICAgICAgIGN1cnJlbnRDb250ZW50TGlua3MucHVzaChuZXdJdGVtKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFkZHMgdGhlIG5ldyBsaW5rIHRvIHRoZSBsaXN0IG9mIHRoZSBjdXJyZW50bHkgcmVsYXRlZCBsaW5rcyBzaG93biB0byB0aGUgdXNlci5cclxuICAgICAgICAgICAgdmFyIGh0bWwgPSAnPGxpIGNsYXNzPVwibGFzdFwiPjxkaXYgY2xhc3M9XCJzdW1tYXJ5XCI+PGRpdiBjbGFzcz1cInByb3BlcnRpZXNcIj48aDM+JyArIG5ld0l0ZW0uTGFiZWwgKyAnPC9oMz4gLSAnO1xyXG4gICAgICAgICAgICBodG1sICs9IChuZXdJdGVtLkNvbnRlbnRJdGVtSWQgIT09IDApID8gJHJlbGF0ZWRDb250ZW50Q29udGVudERpc3BsYXlMaW5rLnZhbCgpIDogJzxhIGhyZWY9JyArIG5ld0l0ZW0uVXJsICsgJyB0YXJnZXQ9XCJfYmxhbmtcIj4nICsgbmV3SXRlbS5VcmwgKyAnPC9hPic7XHJcbiAgICAgICAgICAgIGh0bWwgKz0gJzwvZGl2PjxkaXYgY2xhc3M9XCJyZWxhdGVkXCI+PGEgaHJlZj1cIiNcIiBkYXRhLWluZGV4PVwiJyArIChjdXJyZW50Q29udGVudExpbmtzLmxlbmd0aCAtIDEpICsgJ1wiIGNsYXNzPVwianMtZWRpdC1yZWxhdGVkLWNvbnRlbnRcIj5FZGl0PC9hPiB8IDxhIGhyZWY9XCIjXCIgZGF0YS1pbmRleD1cIicgKyAoY3VycmVudENvbnRlbnRMaW5rcy5sZW5ndGggLSAxKSArICdcIiBjbGFzcz1cImpzLXJlbW92ZS1yZWxhdGVkLWNvbnRlbnRcIj5EZWxldGU8L2E+PC9kaXY+PC9kaXY+PC9saT4nO1xyXG5cclxuICAgICAgICAgICAgJHJlbGF0ZWRDb250ZW50c0xpc3QuY2hpbGRyZW4oKS5yZW1vdmVDbGFzcygnbGFzdCcpO1xyXG4gICAgICAgICAgICAkcmVsYXRlZENvbnRlbnRzTGlzdC5hcHBlbmQoaHRtbCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy91cGRhdGUgZXhpc3RpbmcgZWxlbWVudCBhbmQgc2hvd1xyXG4gICAgICAgICAgICAvLyBmaW5kcyBsaW5rIGluIHRoZSBsaXN0LlxyXG4gICAgICAgICAgICB2YXIgJGl0ZW0gPSAkcmVsYXRlZENvbnRlbnRzTGlzdC5maW5kKCdbZGF0YS1pbmRleD0nICsgZWRpdEluZGV4ICsgJ10nKS5wYXJlbnRzKCdsaScpO1xyXG5cclxuICAgICAgICAgICAgLy8gZmluZHMgbGluayBpbiB0aGUgY3VycmVudCBpdGVtcyBhcnJheS5cclxuICAgICAgICAgICAgdmFyIGl0ZW1JbmRleCA9IC0xO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGN1cnJlbnRDb250ZW50TGlua3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Q29udGVudExpbmtzW2ldLkxhYmVsID09PSAkaXRlbS5maW5kKCdoMycpLnRleHQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGl0ZW1JbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGN1cnJlbnRDb250ZW50TGlua3NbaXRlbUluZGV4XS5Db250ZW50SXRlbUlkID0gZ2V0UmVsYXRlZENvbnRlbnRDb250ZW50SXRlbUlkKCk7XHJcbiAgICAgICAgICAgIGN1cnJlbnRDb250ZW50TGlua3NbaXRlbUluZGV4XS5MYWJlbCA9IGdldFJlbGF0ZWRDb250ZW50VGV4dCgpO1xyXG5cclxuICAgICAgICAgICAgdmFyICRwcm9wZXJ0aWVzID0gJGl0ZW0uZmluZCgnLnByb3BlcnRpZXMnKTtcclxuICAgICAgICAgICAgJHByb3BlcnRpZXMuZmluZCgnaDMnKS50ZXh0KGN1cnJlbnRDb250ZW50TGlua3NbaXRlbUluZGV4XS5MYWJlbCk7XHJcbiAgICAgICAgICAgICRwcm9wZXJ0aWVzLmZpbmQoJ2EnKS5yZW1vdmUoKTtcclxuICAgICAgICAgICAgJHByb3BlcnRpZXMuYXBwZW5kKCRyZWxhdGVkQ29udGVudENvbnRlbnREaXNwbGF5TGluay52YWwoKSk7XHJcbiAgICAgICAgICAgIHJlc2V0RWRpdCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdXBkYXRlcyB0aGUgSlNPTiB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBzZXJ2ZXIuXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50SnNvbi52YWwoSlNPTi5zdHJpbmdpZnkoY3VycmVudENvbnRlbnRMaW5rcykpO1xyXG5cclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRzTGlzdENvbnRhaW5lci5zaG93KCk7XHJcblxyXG4gICAgICAgICQoJy5qcy1yZW1vdmUtcmVsYXRlZC1jb250ZW50Jykub24oJ2NsaWNrJywgcmVtb3ZlTGluayk7XHJcbiAgICAgICAgJCgnLmpzLWVkaXQtcmVsYXRlZC1jb250ZW50Jykub24oJ2NsaWNrJywgZWRpdExpbmspO1xyXG5cclxuICAgICAgICByZXNldEZvcm0oKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVtb3ZlcyBhbiBleGlzdGluZyByZWxhdGVkIGxpbmsuXHJcbiAgICAgKi9cclxuICAgIHZhciByZW1vdmVMaW5rID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIGluZGV4ID0gJCh0aGlzKS5hdHRyKCdkYXRhLWluZGV4Jyk7XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZXMgbGluayBmcm9tIHRoZSBsaXN0LlxyXG4gICAgICAgIHZhciAkaXRlbSA9ICRyZWxhdGVkQ29udGVudHNMaXN0LmZpbmQoJ1tkYXRhLWluZGV4PScgKyBpbmRleCArICddJykucGFyZW50cygnbGknKTtcclxuXHJcbiAgICAgICAgLy8gcmVtb3ZlcyBsaW5rIGZyb20gdGhlIGN1cnJlbnQgaXRlbXMgYXJyYXkuXHJcbiAgICAgICAgdmFyIGl0ZW1JbmRleCA9IC0xO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY3VycmVudENvbnRlbnRMaW5rcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoY3VycmVudENvbnRlbnRMaW5rc1tpXS5MYWJlbCA9PT0gJGl0ZW0uZmluZCgnaDMnKS50ZXh0KCkpIHtcclxuICAgICAgICAgICAgICAgIGl0ZW1JbmRleCA9IGk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChpdGVtSW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICBjdXJyZW50Q29udGVudExpbmtzLnNwbGljZShpdGVtSW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgJGl0ZW0ucmVtb3ZlKCk7XHJcblxyXG4gICAgICAgIC8vIHVwZGF0ZXMgdGhlIEpTT04gdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgc2VydmVyLlxyXG4gICAgICAgICRyZWxhdGVkQ29udGVudEpzb24udmFsKEpTT04uc3RyaW5naWZ5KGN1cnJlbnRDb250ZW50TGlua3MpKTtcclxuXHJcbiAgICAgICAgLy8gaGlkZSB0aGUgbGlua3MgbGlzdCBpZiB0aGVyZSBhcmVuJ3QgYW55LlxyXG4gICAgICAgIGlmIChjdXJyZW50Q29udGVudExpbmtzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAkcmVsYXRlZENvbnRlbnRzTGlzdENvbnRhaW5lci5oaWRlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBlbnN1cmUgdGhlIGh5cGVybGluayBkb2Vzbid0IHRyaWdnZXIuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRWRpdHMgYW4gZXhpc3RpbmcgcmVsYXRlZCBsaW5rLlxyXG4gICAgICovXHJcbiAgICB2YXIgZWRpdExpbmsgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXNldEVkaXQoKTtcclxuICAgICAgICBtb2RlID0gJ2VkaXQnO1xyXG4gICAgICAgIHZhciBpbmRleCA9ICQodGhpcykuYXR0cignZGF0YS1pbmRleCcpO1xyXG5cclxuICAgICAgICAvLyBmaW5kcyBsaW5rIGluIHRoZSBsaXN0LlxyXG4gICAgICAgIHZhciAkaXRlbSA9ICRyZWxhdGVkQ29udGVudHNMaXN0LmZpbmQoJ1tkYXRhLWluZGV4PScgKyBpbmRleCArICddJykucGFyZW50cygnbGknKTtcclxuXHJcbiAgICAgICAgLy8gZmluZHMgbGluayBpbiB0aGUgY3VycmVudCBpdGVtcyBhcnJheS5cclxuICAgICAgICB2YXIgaXRlbUluZGV4ID0gLTE7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjdXJyZW50Q29udGVudExpbmtzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50Q29udGVudExpbmtzW2ldLkxhYmVsID09PSAkaXRlbS5maW5kKCdoMycpLnRleHQoKSkge1xyXG4gICAgICAgICAgICAgICAgaXRlbUluZGV4ID0gaTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgJGl0ZW0uaGlkZSgpO1xyXG5cclxuICAgICAgICBlZGl0SW5kZXggPSBpdGVtSW5kZXg7XHJcblxyXG4gICAgICAgIC8vIHVwZGF0ZXMgdGhlIHVpIHRvIGRpc3BsYXkgZWRpdCBmb3IgdGhpcyBpdGVtXHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50Rm9ybS5zaG93KCk7XHJcbiAgICAgICAgJHJlbGF0ZWRDb250ZW50QWRkQnV0dG9uLmhpZGUoKTtcclxuICAgICAgICB2YXIgJHByb3BlcnRpZXMgPSAkaXRlbS5maW5kKCcucHJvcGVydGllcycpO1xyXG4gICAgICAgICRyZWxhdGVkQ29udGVudFRleHQudmFsKCRwcm9wZXJ0aWVzLmZpbmQoJ2gzJykudGV4dCgpKTtcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50SWQudmFsKGN1cnJlbnRDb250ZW50TGlua3NbaXRlbUluZGV4XS5Db250ZW50SXRlbUlkKTtcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50VGl0bGUudGV4dCgkcHJvcGVydGllcy5maW5kKCdhJykudGV4dCgpKTtcclxuICAgICAgICAkcmVsYXRlZENvbnRlbnRDb250ZW50RGlzcGxheUxpbmsudmFsKCRwcm9wZXJ0aWVzLmZpbmQoJ2EnKVswXS5vdXRlckhUTUwpO1xyXG4gICAgICAgIHZhbGlkYXRlKCk7XHJcblxyXG4gICAgICAgIC8vIGVuc3VyZSB0aGUgaHlwZXJsaW5rIGRvZXNuJ3QgdHJpZ2dlci5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciByZXNldEVkaXQgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICAkKCcuanMtcmVsYXRlZC1jb250ZW50cy1saW5rcy1saXN0ID4gbGknKS5zaG93KCk7XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIHJlbW92aW5nIGEgY3VycmVudCByZWxhdGVkIGxpbmsuXHJcbiAgICAkKCcuanMtcmVtb3ZlLXJlbGF0ZWQtY29udGVudCcpLm9uKCdjbGljaycsIHJlbW92ZUxpbmspO1xyXG4gICAgLy8gZWRpdGluZyBhIGN1cnJlbnQgcmVsYXRlZCBsaW5rLlxyXG4gICAgJCgnLmpzLWVkaXQtcmVsYXRlZC1jb250ZW50Jykub24oJ2NsaWNrJywgZWRpdExpbmspO1xyXG59KTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
